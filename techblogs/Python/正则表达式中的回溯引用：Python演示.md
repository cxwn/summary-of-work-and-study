# 正则表达式中的回溯引用：Python演示

## 一 背景

假设你有一段文本，你想把这段文本里所有连续重复出现的单词（打字错误，其中有一个单词输了两遍）找出来。显然，在搜索某个单词的第二次出现时，这个单词必须是已知的。回溯引用允许正则表达式模式引用前面的匹配结果（具体到这个例子，就是前面匹配到的单词）。把这个问题弄明白的最佳办法是看看它到底是如何工作的。让我们一起来看一个例子：

```tex
<H1>Welcome to my Homepage</H1>
Content is divided into two sections：<BR>
<H2>ColdFusion</H2>
Information about Macromedia ColdFusion.
<H2>Wireless</H2>
Information about Bluetooth, 802.11, and more.
<H2>This is not valid HTML</H3>
```

通过正则表达式来把其中的`<H>`标签匹配出来，代码如下：

```python
# -*- coding:utf-8 -*-
import re
regex=re.compile('<[Hh][1-6]>.*?</[Hh][1-6]>')
ob = open('text.txt','r', encoding = 'utf-8')
context = ob.read()
ob.close()
match = regex.findall(context)
print(match)
```

我们主要关注一下这一小段代码中的正则表达式部分：

```regex
<[Hh][1-6]>.*?</[Hh][1-6]>
```

结果：

```tex
['<H1>Welcome to my Homepage</H1>', '<H2>ColdFusion</H2>', '<H2>Wireless</H2>', '<H2>This is not valid HTML</H3>']
```

重点观察最后一个标签，我们发现匹配结果中`<H2></H3>`被成对匹配，这并不符合我们的预期，遇到这一类问题怎么来处理呢？

通过查阅相关资料，我们可以使用正则表达式中的回溯来解决这一类问题。

## 二 正则表达式中的回溯

当一个正则表达式扫描目标字符串时，它从左到右逐个扫描正则表达式的组成部分，在每个位置上测试能不能找到一个匹配。对于每一个量词和分支，都必须决定如何继续进行。如果是一个量词（诸如*，+?，或者{2,}），正则表达式必须决定何时尝试匹配更多的字符；如果遇到分支（通过|操作符），它必须从这些选项中选择一个进行尝试。每当正则表达式做出这样的决定，如果有必要的话，它会记住另一个选项，以备将来返回后使用。如果所选方案匹配成功，正则表达式将继续扫描正则表达式模板，如果其余部分匹配也成功了，那么匹配就结束了。但是如果所选择的方案未能发现相应匹配，或者后来的匹配也失败了，正则表达式将回溯到最后一个决策点，然后在剩余的选项中选择一个。它继续这样下去，直到找到一个匹配，或者量词和分支选项的所有可能的排列组合都尝试失败了，那么它将放弃这一过程，然后移动到此过程开始位置的下一个字符上，重复此过程。
